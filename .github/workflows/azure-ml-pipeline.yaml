name: Azure ML MNIST Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: 'mlproject'
  WORKSPACE_NAME: 'mlprojectws'
  SUBSCRIPTION_ID: '6f293a1e-1dca-4a4a-ae35-67ac8536d9dd'

jobs:
  setup-and-train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Azure ML CLI
      run: |
        az extension add -n ml -y
        pip install azure-ai-ml azure-identity
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set Azure ML defaults
      run: |
        az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE_NAME
    
    - name: Create/Update Compute
      run: |
        az ml compute create --file environment/compute.yaml
      continue-on-error: true
    
    - name: Create/Update Environments
      run: |
        az ml environment create --file environment/preprocessing.yaml
        az ml environment create --file environment/training.yaml
    
    - name: Create/Update Components
      run: |
        az ml component create --file components/dataprep/dataprep.yaml
        az ml component create --file components/training/training.yaml
    
    - name: Run Pipeline
      id: run_pipeline
      run: |
        RUN_ID=$(az ml job create --file pipelines/mnist-classification.yaml --query name -o tsv)
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Pipeline submitted with ID: $RUN_ID"
    
    - name: Wait for Pipeline Completion
      run: |
        az ml job show --name ${{ steps.run_pipeline.outputs.run_id }} --web
        
        # Wait for completion (with timeout)
        timeout=3600  # 1 hour
        elapsed=0
        interval=30
        
        while [ $elapsed -lt $timeout ]; do
          status=$(az ml job show --name ${{ steps.run_pipeline.outputs.run_id }} --query status -o tsv)
          echo "Pipeline status: $status"
          
          if [ "$status" = "Completed" ]; then
            echo "Pipeline completed successfully!"
            exit 0
          elif [ "$status" = "Failed" ] || [ "$status" = "Canceled" ]; then
            echo "Pipeline failed or was canceled"
            exit 1
          fi
          
          sleep $interval
          elapsed=$((elapsed + interval))
        done
        
        echo "Pipeline timed out"
        exit 1
    
    - name: Download Model
      shell: bash
      run: |
        az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE_NAME
        
        echo "Downloading model from job: ${{ steps.run_pipeline.outputs.run_id }}"
        
        # Get the training child job name
        TRAINING_JOB=$(az ml job list --parent-job-name ${{ steps.run_pipeline.outputs.run_id }} --query "[?display_name=='MNIST Model Training'].name" -o tsv)
        echo "Training job: $TRAINING_JOB"
        
        # Download from the training job directly
        mkdir -p ./model-downloads
        az ml job download \
          --name $TRAINING_JOB \
          --output-name model_output \
          --download-path ./model-downloads
        
        echo "‚úÖ Download complete"
        echo "Structure:"
        ls -R ./model-downloads
        
        # Find and copy model.keras
        mkdir -p ./model
        find ./model-downloads -name "model.keras" -type f -print -exec cp {} ./model/ \;
        
        # Verify
        if [ -f ./model/model.keras ]; then
          echo "‚úÖ Model found!"
          ls -lh ./model/
        else
          echo "‚ùå Still not found. Trying to find ANY files:"
          find ./model-downloads -type f
          
          # Last resort - check if model was saved at all
          echo "Checking training job outputs:"
          az ml job show --name $TRAINING_JOB --query outputs
          exit 1
        fi

    - name: Debug - Show Everything
      if: always()
      run: |
        echo "=== Current Directory ==="
        pwd
        ls -la
        
        echo "=== Model Directory ==="
        ls -la ./model/ || echo "No ./model directory"
        
        echo "=== All .keras files ==="
        find . -name "*.keras" -type f || echo "No .keras files found"

    - name: Upload model artifact
      uses: actions/upload-artifact@v4
      with:
        name: mnist-model
        path: ./model/model.keras


  build-and-deploy:
    needs: setup-and-train
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Model Artifact
      uses: actions/download-artifact@v4
      with:
        name: mnist-model
        path: ./inference/model

    - name: Verify Model Downloaded
      run: |
        echo "Checking model location..."
        ls -la ./inference/model/
        if [ ! -f ./inference/model/model.keras ]; then
          echo "‚ùå Model not found!"
          exit 1
        fi
        echo "‚úÖ Model ready for Docker build"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ secrets.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true
    
    - name: Build and Push Docker Image
      uses: docker/build-push-action@v4
      with:
        context: ./inference
        push: true
        tags: |
          ${{ secrets.DOCKER_REGISTRY }}/mnist-classifier:latest
          ${{ secrets.DOCKER_REGISTRY }}/mnist-classifier:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/mnist-classifier:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_REGISTRY }}/mnist-classifier:buildcache,mode=max
      continue-on-error: true
    
    - name: Build Docker Image Locally (Fallback)
      if: failure()
      run: |
        echo "‚ö†Ô∏è  Registry push failed or not configured. Building locally..."
        docker build -t mnist-classifier:latest ./inference
        echo "‚úÖ Local build successful"
    
    - name: Deploy to Kubernetes (Optional)
      if: github.ref == 'refs/heads/main'
      run: |
        echo "üöÄ Kubernetes deployment ready"
        # kubectl apply -f ./kubernetes/deployment.yaml
        # kubectl apply -f ./kubernetes/service.yaml
        # kubectl set image deployment/mnist-classifier mnist-api=${{ secrets.DOCKER_REGISTRY }}/mnist-classifier:${{ github.sha }}