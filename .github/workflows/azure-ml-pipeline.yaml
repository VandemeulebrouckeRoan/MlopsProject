name: Azure ML MNIST Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: 'mlproject'
  WORKSPACE_NAME: 'mlprojectws'
  SUBSCRIPTION_ID: '6f293a1e-1dca-4a4a-ae35-67ac8536d9dd'

jobs:
  setup-and-train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Azure ML CLI
      run: |
        az extension add -n ml -y
        pip install azure-ai-ml azure-identity
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set Azure ML defaults
      run: |
        az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE_NAME
    
    - name: Create/Update Compute
      run: |
        az ml compute create --file environment/compute.yaml
      continue-on-error: true
    
    - name: Create/Update Environments
      run: |
        az ml environment create --file environment/preprocessing.yaml
        az ml environment create --file environment/training.yaml
    
    - name: Create/Update Components
      run: |
        az ml component create --file components/dataprep/dataprep.yaml
        az ml component create --file components/training/training.yaml
    
    - name: Run Pipeline
      id: run_pipeline
      run: |
        RUN_ID=$(az ml job create --file pipelines/mnist-classification.yaml --query name -o tsv)
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Pipeline submitted with ID: $RUN_ID"
    
    - name: Wait for Pipeline Completion
      run: |
        az ml job show --name ${{ steps.run_pipeline.outputs.run_id }} --web
        
        # Wait for completion (with timeout)
        timeout=3600  # 1 hour
        elapsed=0
        interval=30
        
        while [ $elapsed -lt $timeout ]; do
          status=$(az ml job show --name ${{ steps.run_pipeline.outputs.run_id }} --query status -o tsv)
          echo "Pipeline status: $status"
          
          if [ "$status" = "Completed" ]; then
            echo "Pipeline completed successfully!"
            exit 0
          elif [ "$status" = "Failed" ] || [ "$status" = "Canceled" ]; then
            echo "Pipeline failed or was canceled"
            exit 1
          fi
          
          sleep $interval
          elapsed=$((elapsed + interval))
        done
        
        echo "Pipeline timed out"
        exit 1
    
    - name: Download Model
      shell: bash
      run: |
        az configure --defaults group=$RESOURCE_GROUP workspace=$WORKSPACE_NAME
        
        echo "Pipeline job: ${{ steps.run_pipeline.outputs.run_id }}"
        
        # List all child jobs to find the training job
        echo "Finding training child job..."
        az ml job list --parent-job-name ${{ steps.run_pipeline.outputs.run_id }} --query "[].{name:name, display_name:display_name}" -o table
        
        # Get the training job name (it's the second job after dataprep)
        TRAINING_JOB=$(az ml job list --parent-job-name ${{ steps.run_pipeline.outputs.run_id }} --query "[?contains(display_name, 'Training') || contains(display_name, 'training')].name" -o tsv | head -1)
        
        if [ -z "$TRAINING_JOB" ]; then
          echo "Training job not found, trying alternative approach..."
          # Get all child jobs and take the last one (training is usually last)
          TRAINING_JOB=$(az ml job list --parent-job-name ${{ steps.run_pipeline.outputs.run_id }} --query "[-1].name" -o tsv)
        fi
        
        echo "Training job ID: $TRAINING_JOB"
        
        if [ -z "$TRAINING_JOB" ]; then
          echo "‚ùå Could not find training job"
          exit 1
        fi
        
        # Download from the training job
        echo "Downloading model from training job..."
        mkdir -p ./model-downloads
        
        az ml job download \
          --name $TRAINING_JOB \
          --output-name model_output \
          --download-path ./model-downloads
        
        echo "‚úÖ Download complete"
        echo "Structure:"
        ls -R ./model-downloads
        
        # Find and copy model.keras
        mkdir -p ./model
        find ./model-downloads -name "model.keras" -type f -print -exec cp {} ./model/ \;
        
        # Verify
        if [ -f ./model/model.keras ]; then
          echo "‚úÖ Model found!"
          ls -lh ./model/
        else
          echo "‚ùå model.keras not found"
          echo "All downloaded files:"
          find ./model-downloads -type f
          
          # Show what outputs are available
          echo "Available outputs from training job:"
          az ml job show --name $TRAINING_JOB --query outputs -o json
          exit 1
        fi

    - name: Debug - Show Everything
      if: always()
      run: |
        echo "=== Current Directory ==="
        pwd
        ls -la
        
        echo "=== Model Directory ==="
        ls -la ./model/ || echo "No ./model directory"
        
        echo "=== All .keras files ==="
        find . -name "*.keras" -type f || echo "No .keras files found"

    - name: Upload model artifact
      uses: actions/upload-artifact@v4
      with:
        name: mnist-model
        path: ./model/model.keras


  build-and-deploy:
    needs: setup-and-train
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Model Artifact
      uses: actions/download-artifact@v4
      with:
        name: mnist-model
        path: ./inference/model

    - name: Verify Model Downloaded
      run: |
        echo "Checking model location..."
        ls -la ./inference/model/
        if [ ! -f ./inference/model/model.keras ]; then
          echo "‚ùå Model not found!"
          exit 1
        fi
        echo "‚úÖ Model ready for Docker build"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker Image
      run: |
        docker build -t mnist-classifier:latest ./inference
        echo "‚úÖ Docker build successful"
    
    - name: Stop Old Container (if running)
      run: |
        docker stop mnist-classifier-app 2>/dev/null || true
        docker rm mnist-classifier-app 2>/dev/null || true
        echo "‚úÖ Cleaned up old container"
    
    - name: Run Docker Container
      run: |
        docker run -d \
          --name mnist-classifier-app \
          -p 8000:8000 \
          --restart unless-stopped \
          mnist-classifier:latest
        
        echo "‚úÖ Container started!"
        echo "Waiting for app to be ready..."
        sleep 5
        
        # Check if it's running
        if docker ps | grep -q mnist-classifier-app; then
          echo "‚úÖ Container is running"
          docker logs mnist-classifier-app
        else
          echo "‚ùå Container failed to start"
          docker logs mnist-classifier-app
          exit 1
        fi
    
    - name: Test API
      run: |
        echo "Testing API health endpoint..."
        sleep 3
        curl -f http://localhost:8000/health || exit 1
        echo "‚úÖ API is responding!"
    
    - name: Display Access Information
      run: |
        echo "========================================="
        echo "üéâ Deployment Complete!"
        echo "========================================="
        echo ""
        echo "üåê Web UI: http://localhost:8000"
        echo "üìö API Docs: http://localhost:8000/docs"
        echo "‚ù§Ô∏è  Health: http://localhost:8000/health"
        echo ""
        echo "Container name: mnist-classifier-app"
        echo "To view logs: docker logs mnist-classifier-app"
        echo "To stop: docker stop mnist-classifier-app"
        echo ""
        echo "========================================="

